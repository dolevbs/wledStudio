!function(){"use strict";function t(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Number.isFinite(t)?Math.min(255,Math.max(0,Math.round(t))):e}function e(t,e,s){let a=t/255*6,r=e/255,i=s/255,n=Math.floor(a),o=a-n,l=i*(1-r),h=i*(1-r*o),f=i*(1-r*(1-o)),[u,c,m]=[[i,f,l],[h,i,l],[l,i,f],[l,h,i],[f,l,i],[i,l,h]][n%6];return[Math.round(255*u),Math.round(255*c),Math.round(255*m)]}function s(t){let e=0|t;return e^=e<<13,e^=e>>17,(e^=e<<5)>>>0}function a(t,e,s){let a=Math.max(0,Math.min(1,s));return[Math.round(t[0]+(e[0]-t[0])*a),Math.round(t[1]+(e[1]-t[1])*a),Math.round(t[2]+(e[2]-t[2])*a)]}function r(e,s){return[t(e[0]*s,0),t(e[1]*s,0),t(e[2]*s,0)]}function i(t){return t[0]>0||t[1]>0||t[2]>0}class n{init(t){let e=Math.max(1,Math.min(1e5,Math.round(t)));this.state.ledCount=e,this.state.frame=new Uint8Array(3*e),this.state.lastError=""}jsonCommand(e){try{let s=JSON.parse(e);this.state.lastError="","boolean"==typeof s.on&&(this.state.on=s.on),"number"==typeof s.bri&&(this.state.bri=t(s.bri,this.state.bri));let a=Array.isArray(s.seg)?s.seg[0]:s.seg;if(a&&("number"==typeof a.fx&&(this.state.fx=t(a.fx,this.state.fx)),"number"==typeof a.sx&&(this.state.sx=t(a.sx,this.state.sx)),"number"==typeof a.ix&&(this.state.ix=t(a.ix,this.state.ix)),"number"==typeof a.pal&&(this.state.pal=t(a.pal,this.state.pal)),"number"==typeof a.c1&&(this.state.c1=t(a.c1,this.state.c1)),"number"==typeof a.c2&&(this.state.c2=t(a.c2,this.state.c2)),Array.isArray(a.col))){let e=[[...this.state.colors[0]],[...this.state.colors[1]],[...this.state.colors[2]]];for(let s=0;s<3;s+=1){let r=a.col[s];Array.isArray(r)&&r.length>=3&&(e[s]=[t(r[0]),t(r[1]),t(r[2])])}this.state.colors=e}}catch(t){this.state.lastError="json parse failed: ".concat(String(t))}}renderFrame(t){if(!this.state.on)return this.state.frame.fill(0),this.state.frame;switch(this.state.fx){case 0:this.renderSolid();break;case 1:this.renderBlink(t);break;case 2:this.renderBreath(t);break;case 20:this.renderSparkle(t);break;case 28:this.renderChase(t);break;case 8:case 37:case 41:case 45:case 57:case 63:this.renderRainbow(t,!1);break;case 9:this.renderRainbow(t,!0);break;default:this.renderMappedEffect(t)}return this.state.frame}getBufferSize(){return this.state.frame.length}getLastError(){return this.state.lastError}renderSolid(){let[t,e]=this.state.colors;for(let s=0;s<this.state.ledCount;s+=1){let r=this.state.c1>0?s/Math.max(1,this.state.ledCount-1)*(this.state.c1/255):0,i=r>0?a(t,e,r):t,[n,o,l]=this.applyBrightness(i),h=3*s;this.state.frame[h]=n,this.state.frame[h+1]=o,this.state.frame[h+2]=l}}renderBlink(t){let e=120+(255-this.state.sx)*6,s=this.applyBrightness(this.state.colors[0]),a=this.state.c1>0?this.state.c1/255:.2,n=i(this.state.colors[1])?this.applyBrightness(r(this.state.colors[1],a)):[0,0,0],o=Math.floor(t/e)%2==0?s:n;for(let t=0;t<this.state.ledCount;t+=1){let e=3*t;this.state.frame[e]=o[0],this.state.frame[e+1]=o[1],this.state.frame[e+2]=o[2]}}renderBreath(e){let s=Math.max(512,4096+(128-this.state.sx)*24),a=this.state.c1>0?this.state.c1/255:1,r=this.state.bri;this.state.bri=t(r*(1-a+a*(.5+.5*Math.sin(e%s/s*Math.PI*2))),r),this.renderSolid(),this.state.bri=r}renderRainbow(t,s){let a=180+Math.round(this.state.ix/4),r=255&Math.floor(t*(this.state.sx+1)/24),i=s?1+this.state.c1/64:1;if(0===this.state.pal){for(let t=0;t<this.state.ledCount;t+=1){let s=e(r+Math.floor(255*t*i/Math.max(1,this.state.ledCount))&255,a,255),[n,o,l]=this.applyBrightness(s),h=3*t;this.state.frame[h]=n,this.state.frame[h+1]=o,this.state.frame[h+2]=l}return}for(let t=0;t<this.state.ledCount;t+=1){let e=r+Math.floor(255*t*i/Math.max(1,this.state.ledCount))&255,s=this.paletteColor(e,a),[n,o,l]=this.applyBrightness(s),h=3*t;this.state.frame[h]=n,this.state.frame[h+1]=o,this.state.frame[h+2]=l}}renderSparkle(t){this.renderSolid();let e=Math.max(1,Math.floor(this.state.ledCount*(this.state.ix+16)/2048)),r=i(this.state.colors[1])?this.state.colors[1]:[255,255,255],n=Math.max(1,31+Math.floor((this.state.sx-128)/4)),o=this.state.c1/255;for(let i=0;i<e;i+=1){let e=s(2654435769*i+t*n),l=e%this.state.ledCount*3,h=this.state.pal>0?this.paletteColor(e+t&255,255):r,f=o>0?a(h,this.state.colors[2],o):h,[u,c,m]=this.applyBrightness(f);this.state.frame[l]=u,this.state.frame[l+1]=c,this.state.frame[l+2]=m}}renderChase(t){let e=this.state.c1>0?Math.max(2,2+Math.floor(this.state.c1/18)):Math.max(2,14-Math.floor(this.state.sx/20)),s=Math.floor(t/40)%Math.max(1,this.state.ledCount),a=this.applyBrightness(this.state.colors[0]),n=i(this.state.colors[2])?this.applyBrightness(r(this.state.colors[2],.45)):[0,0,0],o=Math.floor(this.state.c2/52);for(let t=0;t<this.state.ledCount;t+=1){let r=3*t,i=(t+s)%e;if(0===i)this.state.frame[r]=a[0],this.state.frame[r+1]=a[1],this.state.frame[r+2]=a[2];else if(o>0&&i<=o){let t=1-i/(o+1),e=[Math.round(a[0]*t+n[0]*(1-t)),Math.round(a[1]*t+n[1]*(1-t)),Math.round(a[2]*t+n[2]*(1-t))];this.state.frame[r]=e[0],this.state.frame[r+1]=e[1],this.state.frame[r+2]=e[2]}else this.state.frame[r]=n[0],this.state.frame[r+1]=n[1],this.state.frame[r+2]=n[2]}}renderMappedEffect(t){let n=Math.max(1,this.state.ledCount),o=this.state.fx,[l,h,f]=this.state.colors;switch(o%6){case 0:{let e=128+Math.round(this.state.ix/2);for(let s=0;s<n;s+=1){let r=(s/n+t*(this.state.sx+8)*2e-5+.013*o)%1,i=this.state.pal>0?this.paletteColor(Math.floor(255*r),e):a(l,h,r),[f,u,c]=this.applyBrightness(i),m=3*s;this.state.frame[m]=f,this.state.frame[m+1]=u,this.state.frame[m+2]=c}break}case 1:{let e=24+Math.floor(this.state.ix/255*200);for(let i=0;i<n;i+=1){let n=s(2654435769*i+t*(11+o%17)),u=(255&n)<e,c=a(l,f,(n>>>8&255)/255),m=r(h,.08+(this.state.c1+16)/1024),d=u?c:m,[p,M,g]=this.applyBrightness(d),y=3*i;this.state.frame[y]=p,this.state.frame[y+1]=M,this.state.frame[y+2]=g}break}case 2:{let e=Math.floor(t/Math.max(12,42-Math.floor(this.state.sx/8)))%n,s=2+Math.floor((this.state.c2+o%32)/24),h=i(f)?r(f,.1):[0,0,0];for(let t=0;t<n;t+=1){let r=(t-e+n)%n,i=h;r<=s&&(i=a(h,l,1-r/Math.max(1,s)));let[o,f,u]=this.applyBrightness(i),c=3*t;this.state.frame[c]=o,this.state.frame[c+1]=f,this.state.frame[c+2]=u}break}case 3:{let e=1+(o+this.state.c1)%9,s=Math.floor(t/Math.max(14,64-Math.floor(this.state.sx/5)));for(let t=0;t<n;t+=1){let a=Math.floor((t+s)/e)%3,r=0===a?l:1===a?h:f,[i,n,o]=this.applyBrightness(r),u=3*t;this.state.frame[u]=i,this.state.frame[u+1]=n,this.state.frame[u+2]=o}break}case 4:{let e=.002+this.state.sx/255*.016;for(let s=0;s<n;s+=1){let r=a(a(l,h,(Math.sin(s*(.2+o%7*.04)+t*e)+1)*.5),f,this.state.c2/255),[i,n,u]=this.applyBrightness(r),c=3*s;this.state.frame[c]=i,this.state.frame[c+1]=n,this.state.frame[c+2]=u}break}default:{let s=96+Math.round(.6*this.state.ix),a=255&Math.floor(t*(this.state.sx+16)/18),r=1+(o+this.state.c1)%64/64;for(let t=0;t<n;t+=1){let i=a+Math.floor(255*t*r/n)&255,o=this.state.pal>0?this.paletteColor(i,s):e(i,s,255),[l,h,f]=this.applyBrightness(o),u=3*t;this.state.frame[u]=l,this.state.frame[u+1]=h,this.state.frame[u+2]=f}}}}applyBrightness(t){let e=this.state.bri/255;return[Math.round(t[0]*e),Math.round(t[1]*e),Math.round(t[2]*e)]}paletteColor(t,s){let[r,i,n]=this.state.colors,o=(255&t)/255;switch(this.state.pal%5){case 1:return o<.5?a(r,i,2*o):a(i,n,(o-.5)*2);case 2:return a(r,i,(Math.sin(o*Math.PI*2)+1)*.5);case 3:{let t=Math.floor(3*o)%3;return 0===t?r:1===t?i:n}case 4:return a(n,r,o);default:return a(r,e(255&t,s,255),.35)}}constructor(){this.state={ledCount:1,frame:new Uint8Array(3),on:!0,bri:128,fx:8,sx:128,ix:128,pal:0,c1:0,c2:0,colors:[[255,170,0],[0,0,0],[0,0,0]],lastError:""}}}function o(t){return"".concat("").concat(t)}class l{init(t){this.initFn(t)}jsonCommand(t){let e=this.module.lengthBytesUTF8(t)+1,s=this.module._malloc(e);try{this.module.stringToUTF8(t,s,e),this.jsonFn(s)}finally{this.module._free(s)}}renderFrame(t){let e=this.renderFn(t),s=this.getBufferSize();return new Uint8Array(this.module.HEAPU8.subarray(e,e+s))}getBufferSize(){return Number(this.sizeFn())}getLastError(){let t=Number(this.errorFn());return t?this.module.UTF8ToString(t):""}constructor(t){this.module=t,this.initFn=t.cwrap("wled_init",null,["number"]),this.jsonFn=t.cwrap("wled_json_command",null,["number"]),this.renderFn=t.cwrap("wled_render_frame","number",["number"]),this.sizeFn=t.cwrap("wled_get_buffer_size","number",[]),this.errorFn=t.cwrap("wled_get_last_error","number",[])}}async function h(){if("undefined"==typeof self)return console.log("[wasmClient] self is undefined; falling back to software engine"),null;try{if(!self.WLEDModule){let t=o("/wasm/wled.js");console.log("[wasmClient] importing ".concat(t)),importScripts(t)}let t=self.WLEDModule;return t||console.warn("[wasmClient] WLEDModule factory missing after importScripts"),null!=t?t:null}catch(t){return console.warn("[wasmClient] failed to load wasm module factory; using software engine",t),null}}async function f(){let t=await h();if(!t)return console.log("[wasmClient] software engine selected (no wasm factory)"),new n;try{console.log("[wasmClient] creating wasm engine instance");let e=await t({locateFile:t=>t.endsWith(".wasm")?o("/wasm/".concat(t)):t});return console.log("[wasmClient] wasm engine ready"),new l(e)}catch(t){return console.warn("[wasmClient] wasm engine creation failed; using software engine",t),new n}}let u=null,c=300,m=!1,d=30,p=0,M=null,g=0,y=null;function w(t,e){postMessage({type:"diag",source:"sim.worker",event:t,data:null!=e?e:{}}),console.log("[sim.worker]",t,null!=e?e:{})}function x(){return Math.max(1,Math.floor(1e3/Math.max(1,d)))}function b(){if(M&&(clearInterval(M),M=null),!m||!u){w("scheduleLoop:idle",{running:m,hasEngine:!!u,ledCount:c,simTickRate:d});return}w("scheduleLoop:start",{intervalMs:x(),simTickRate:d,ledCount:c}),M=setInterval(()=>{try{p+=x();let a=u.renderFrame(p),r=u.getLastError();if((g+=1)%30==0){var t,e,s;w("tick",{simulatedMillis:p,frameSize:a.length,frameHead:[null!==(t=a[0])&&void 0!==t?t:0,null!==(e=a[1])&&void 0!==e?e:0,null!==(s=a[2])&&void 0!==s?s:0],engineError:r||""})}postMessage({type:"frame",simulatedMillis:p,frame:a,error:r})}catch(e){let t=e instanceof Error?e.message:String(e);w("tick:render:error",{message:t,simulatedMillis:p}),m=!1,b(),postMessage({type:"frame",simulatedMillis:p,frame:new Uint8Array(Math.max(3*c,3)),error:"Render failure: ".concat(t,". Simulation paused to prevent error loop.")})}},x())}async function C(t){var e,s;c=Math.max(1,Math.round(t)),w("initEngine:begin",{requestedLedCount:t,resolvedLedCount:c}),(u=await f()).init(c),p=0,g=0,w("initEngine:ready",{ledCount:c,bufferSize:u.getBufferSize(),engineType:null!==(s=null===(e=u.constructor)||void 0===e?void 0:e.name)&&void 0!==s?s:"unknown"}),postMessage({type:"ready",ledCount:c,bufferSize:u.getBufferSize()})}async function k(t){u||(y||(y=C(t).finally(()=>{y=null})),await y)}self.addEventListener("error",t=>{w("worker:error",{message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno})}),self.addEventListener("unhandledrejection",t=>{w("worker:unhandledrejection",{reason:String(t.reason)})}),self.onmessage=async t=>{let e=t.data;switch(w("onmessage",{type:e.type}),e.type){case"init":d=Math.max(1,Math.round(e.simTickRate)),y&&await y,u?(c=Math.max(1,Math.round(e.ledCount)),u.init(c),p=0,g=0,w("initEngine:reinit",{ledCount:c})):await C(e.ledCount),b();return;case"running":w("running:update",{running:m=e.running}),b();return;case"topology":await k(e.ledCount),c=Math.max(1,Math.round(e.ledCount)),u.init(c),b();return;case"json":await k(c),w("json:apply",{payloadPreview:e.payload.slice(0,180)}),u.jsonCommand(e.payload);return;case"reset":p=0,g=0,u&&u.init(c),w("clock:reset",{ledCount:c});return;default:return}}}(),_N_E={};